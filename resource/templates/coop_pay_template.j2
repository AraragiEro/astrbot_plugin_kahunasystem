<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资产分析</title>
    <script src="https://cdn.jsdmirror.com/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdmirror.com/npm/chart.js"></script>
    <script src="https://cdn.jsdmirror.com/npm/chartjs-adapter-date-fns"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <script src="https://cdn.jsdmirror.com/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdmirror.com/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container w-[calc(100%-20px)] max-w-[1920px] mx-auto px-2 py-8">
        <!-- 标题区域 -->
        <div class="relative h-[150px] mb-8 rounded-lg overflow-hidden">
            <!-- 背景图片 -->
            <img src="data:image/png;base64,{{ header_image }}" alt="背景" class="absolute inset-0 w-full h-full object-cover">
            <!-- 标题内容 -->
            <div class="absolute inset-0 flex justify-between items-center px-8">
                <h1 class="text-3xl font-bold text-white shadow-text"> {{ header_title }} </h1>
            </div>
        </div>
        
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm font-medium">总工时</h3>
                <p class="text-l font-bold text-gray-900">{{ (data.values() | sum(attribute='work_time') | round(2)) }} 天</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm font-medium">总支付金额</h3>
                <p class="text-l font-bold text-gray-900">{{ (data.values() | sum(attribute='pay') | round(2)) | format_currency }} ISK</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm font-medium">总手续费</h3>
                <p class="text-l font-bold text-gray-900">{{ (data.values() | sum(attribute='tex') | round(2)) | format_currency }} ISK</p>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">工时分布</h3>
                <canvas id="workTimeChart" class="w-full h-64"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">支付金额分布</h3>
                <canvas id="payChart" class="w-full h-64"></canvas>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">合作方支付明细</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">合作方</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">工时(天)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">手续费(ISK)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">支付金额(ISK)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时薪(ISK/天)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for id, info in data.items() %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <img class="h-10 w-10 rounded-full" src="data:image/jpeg;base64,{{ info.portrait }}" alt="{{ info.name }}">
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">{{ info.name }}</div>
                                        <div class="text-sm text-gray-500">ID: {{ info.id }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ info.work_time | round(2) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ info.tex | format_currency }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ info.pay | format_currency }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ((info.pay - info.tex) / info.work_time) | round(2) | format_currency }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- 移动到最外层的页脚 -->
    <div class="text-center text-gray-500 text-sm mt-4">
        <p>紫竹梅实验型工业核心mk.1 - 报酬计算 - kahunaBot</p>
    </div>
    </div>

    <script>
        // 数据准备
        const data = {{ data }};
        const names = Object.values(data).map(item => item.name);
        const workTimes = Object.values(data).map(item => item.work_time);
        const pays = Object.values(data).map(item => item.pay);
        
        // 颜色配置
        const colors = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
            '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#A855F7'
        ];

        // 工时分布图表
        new Chart(document.getElementById('workTimeChart'), {
            type: 'pie',
            data: {
                labels: names,
                datasets: [{
                    data: workTimes,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${value.toFixed(2)}天 (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // 支付金额分布图表
        new Chart(document.getElementById('payChart'), {
            type: 'pie',
            data: {
                labels: names,
                datasets: [{
                    data: pays,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${(value/1000000).toFixed(2)}M ISK (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>